name: Minecraft Server Engine
on:
  repository_dispatch:
    types: [start_minecraft]

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼†ãƒˆãƒ³ãƒãƒ«é–‹é€š
        run: |
          echo "Gemini programmingéšŠã€æœ€çµ‚ãƒ•ã‚§ãƒ¼ã‚ºã¸ç§»è¡Œï¼"
          
          # 1. ã‚µãƒ¼ãƒãƒ¼æœ¬ä½“ã®æº–å‚™
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/196/downloads/paper-1.20.1-196.jar
          echo "eula=true" > eula.txt
          
          # 2. ngrokã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok jq -y

          # 3. â˜…ã“ã“ãŒæœ€é‡è¦ï¼Authtokenã®ã‚»ãƒƒãƒˆ
          # ç›´æ¥æ›¸ãå ´åˆã¯ï¼šngrok config add-authtoken <å›ã®ãƒˆãƒ¼ã‚¯ãƒ³>
          # Secretsã‚’ä½¿ã†å ´åˆã¯ï¼š
          ngrok config add-authtoken 37Hhnag44xZ1oH3jpFgKV1xUGRW_3WGhQFqLUBSCWU4xSojqF
          
          # 4. ãƒˆãƒ³ãƒãƒ«ã‚’èµ·å‹• (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰)
          ngrok tcp 25565 --log=stdout &
          
          # 5. ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
          sleep 10
          echo "--------------------------------------------------"
          echo "â–¼â–¼â–¼ æ¥ç¶šã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆIPï¼‰ã¯ã“ã‚Œã ï¼ â–¼â–¼â–¼"
          # jqã‚’ä½¿ã£ã¦ngrokã®APIã‹ã‚‰å…¬é–‹URLã‚’å¼•ã£ã“æŠœããï¼
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
          echo "â–²â–²â–² ã“ã‚Œã‚’ã‚¹ãƒãƒ›ã®ãƒã‚¤ã‚¯ãƒ©ã«å…¥åŠ›ã›ã‚ˆ â–²â–²â–²"
          echo "--------------------------------------------------"
          
          # 6. ãƒã‚¤ã‚¯ãƒ©ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒ¡ãƒ¢ãƒªãŸã£ã·ã‚Š7GBï¼ï¼‰
          java -Xmx7G -Xms7G -jar server.jar nogui
          
