name: Minecraft Server Engine
on:
  repository_dispatch:
    types: [start_minecraft]

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 サーバー起動＆トンネル開通
        run: |
          echo "Gemini programming隊、playit最終接続フェーズ！"
          
          # 1. サーバー本体の準備
          curl -o server.jar https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/196/downloads/paper-1.20.1-196.jar
          echo "eula=true" > eula.txt
          
          # 2. playit本体の準備
          curl -SsL -o playit https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
          chmod +x playit

          # 3. playitの起動（サブコマンドなしで直接バックグラウンド起動）
          echo "トンネル接続を開始します..."
          ./playit > playit_log.txt 2>&1 & 
          
          # 4. 少し待ってログからURLを確認（まだ未登録の場合用）
          sleep 5
          echo "--- playit ログ確認 ---"
          cat playit_log.txt | grep "https://playit.gg/claim/" || echo "すでに登録済みか、URL生成待ちです"
          echo "----------------------"
          
          # 5. マイクラサーバー起動
          echo "マイクラサーバーを起動します！"
          java -Xmx7G -Xms7G -jar server.jar nogui
