name: Minecraft Server Engine

on:
  repository_dispatch:
    types: [start_beminecraft]

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      # --- STEP 1: ç’°å¢ƒæ•´å‚™ ---
      - name: "Step 1: ğŸ—ï¸ åŸºç¤ã‚¤ãƒ³ãƒ•ãƒ©ã®æ•´å‚™"
        run: |
          echo "==== [STEP 1 START] ===="
          sudo apt-get update && sudo apt-get install -y libcurl4 curl
          echo "Status: OS dependencies installed âœ…"
          echo "==== [STEP 1 COMPLETE] âœ… ===="

# --- STEP 2: ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ¼ãƒãƒ¼æº–å‚™ (Pythonãƒˆãƒ¼ã‚¯ãƒ³å¥ªå–ä½œæˆ¦) ---
      - name: "Step 2: ğŸ“¦ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®å¥ªå–ï¼ˆPythonè§£æãƒ¢ãƒ¼ãƒ‰ï¼‰"
        run: |
          echo "==== [STEP 2 START] ===="
          FILE_ID="16OlbXH73OzxJvUd80k0ARC0wAzgNm5_-"
          echo "FILE_ID: ${FILE_ID}"

          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãã®å ´ã§ç”Ÿæˆã—ã¦å®Ÿè¡Œ
          python3 - <<EOF
          import requests
          import re
          import os

          file_id = "${FILE_ID}"
          print(f"Target File ID: {file_id}")

          # 1. æœ€åˆã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆè­¦å‘Šç”»é¢ã®HTMLã¨ã‚¯ãƒƒã‚­ãƒ¼ã‚’å–å¾—ï¼‰
          session = requests.Session()
          url = f"https://drive.google.com/uc?export=download&id={file_id}"
          response = session.get(url)
          print(f"Initial Response Status: {response.status_code}")

          # 2. HTMLã‹ã‚‰ confirm ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
          # <input type="hidden" name="confirm" value="XXXX"> ã‚’æ¢ã™
          confirm_match = re.search(r'name="confirm" value="([^"]+)"', response.text)
          
          if confirm_match:
              confirm_token = confirm_match.group(1)
              print(f"confirm_token: {confirm_token}")
              
              # 3. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦æœ¬ç•ªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              download_url = "https://drive.usercontent.google.com/download"
              params = {
                  'id': file_id,
                  'export': 'download',
                  'confirm': confirm_token
              }
              
              print("Status: Starting binary download...")
              final_res = session.get(download_url, params=params, stream=True)
              
              os.makedirs("bds", exist_ok=True)
              with open("bds/bedrock_server", "wb") as f:
                  for chunk in final_res.iter_content(chunk_size=8192):
                      f.write(chunk)
              print("Status: Binary saved to ./bds/bedrock_server âœ…")
          else:
              print("âŒ ERROR: Confirm token not found in HTML!")
              # ãƒ‡ãƒãƒƒã‚°ç”¨ã«HTMLã®ä¸€éƒ¨ã‚’å‡ºåŠ›
              print(response.text[:500])
              exit(1)
          EOF

          # å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
          chmod +x ./bds/bedrock_server
          
          echo "Status: Verifying file content..."
          file_head=\$(head -c 10 ./bds/bedrock_server)
          echo "File Head: \$file_head"
          
          if [[ "\$file_head" == *"<!"* ]]; then
            echo "âŒ CRITICAL ERROR: Still HTML! Aborting."
            exit 1
          fi
          
          ls -lh ./bds/bedrock_server
          echo "==== [STEP 2 COMPLETE] âœ… ===="

      # --- STEP 3: é€šä¿¡å…µ(playit.gg)ã®é…å‚™ ---
      - name: "Step 3: ğŸŒ playit.ggãƒˆãƒ³ãƒãƒ«å…µã®é…å‚™"
        run: |
          echo "==== [STEP 3 START] ===="
          PLAYIT_DL_URL="https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64"
          curl -SsL -o playit ${PLAYIT_DL_URL}
          chmod +x playit
          echo "Status: playit-agent ready âœ…"
          echo "==== [STEP 3 COMPLETE] âœ… ===="

      # --- STEP 4: ãƒˆãƒ³ãƒãƒ«é–‹é€š ---
      - name: "Step 4: âš¡ ãƒˆãƒ³ãƒãƒ«é–‹é€šãƒ—ãƒ­ã‚»ã‚¹"
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          echo "==== [STEP 4 START] ===="
          if [ -z "$PLAYIT_SECRET" ]; then
            ./playit > playit_log.txt 2>&1 &
          else
            ./playit --secret "$PLAYIT_SECRET" > playit_log.txt 2>&1 &
          fi
          sleep 8
          cat playit_log.txt | grep -E "https://playit.gg/claim/|connected" || echo "Status: Waiting..."
          echo "==== [STEP 4 COMPLETE] âœ… ===="

      # --- STEP 5: ã‚µãƒ¼ãƒãƒ¼æœ€çµ‚èµ·å‹• ---
      - name: "Step 5: ğŸ® Minecraft Bedrock Server èµ·å‹•ï¼"
        run: |
          echo "==== [STEP 5 START] ===="
          cd bds
          # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥ç½®ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®ã¾ã¾å©ãï¼
          echo "Executing: LD_LIBRARY_PATH=. ./bedrock_server"
          LD_LIBRARY_PATH=. ./bedrock_server
          echo "==== [STEP 5 FINISHED] ğŸ ===="
