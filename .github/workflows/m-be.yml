name: Minecraft Server-Engine

on:
  repository_dispatch:
    types: [start_beminecraft]

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      # --- STEP 0: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ ---
      - name: "Step 0: ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      # --- STEP 1: ç’°å¢ƒæ•´å‚™ ---
      - name: "Step 1: ğŸ—ï¸ åŸºç¤ã‚¤ãƒ³ãƒ•ãƒ©ã®æ•´å‚™"
        run: |
          echo "==== [STEP 1 START] ===="
          sudo apt-get update && sudo apt-get install -y libcurl4 curl unzip
          echo "Status: OS dependencies installed âœ…"
          echo "==== [STEP 1 COMPLETE] âœ… ===="

      # --- STEP 2: å…¬å¼ãƒ™ãƒ¼ã‚¹ ï¼‹ ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ãƒŠãƒªã®åˆä½“ ---
      - name: "Step 2: ğŸ“¦ ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã®å®Œå…¨æ§‹ç¯‰"
        run: |
          echo "==== [STEP 2 START] ===="
          # 1. æä¾›ã•ã‚ŒãŸå…¬å¼URLã‹ã‚‰ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          OFFICIAL_URL="https://www.minecraft.net/bedrockdedicatedserver/bin-linux/bedrock-server-1.21.131.1.zip"
          echo "OFFICIAL_URL: ${OFFICIAL_URL}"
          
          # User-Agentã‚’æŒ‡å®šã—ãªã„ã¨æ‹’å¦ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚è¿½åŠ 
          curl -L -A "Mozilla/5.0" -o official_bds.zip "${OFFICIAL_URL}"
          unzip official_bds.zip -d bds
          echo "Status: Official base files extracted âœ…"

          # 2. éšŠå“¡ã®ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ãƒŠãƒª(188MB)ã§ä¸Šæ›¸ã
          FILE_ID="16OlbXH73OzxJvUd80k0ARC0wAzgNm5_-"
          python3 - <<EOF
          import requests, re, os
          session = requests.Session()
          res = session.get(f"https://drive.google.com/uc?export=download&id=${FILE_ID}")
          token_match = re.search(r'name="confirm" value="([^"]+)"', res.text)
          confirm_token = token_match.group(1) if token_match else "t"
          final_res = session.get("https://drive.usercontent.google.com/download", params={'id': '${FILE_ID}', 'export': 'download', 'confirm': confirm_token}, stream=True)
          with open("bds/bedrock_server", "wb") as f:
              for chunk in final_res.iter_content(chunk_size=8192): f.write(chunk)
          EOF
          chmod +x ./bds/bedrock_server
          echo "Status: Custom binary (1.21.102.1) deployed over base âœ…"

          # 3. ãƒªãƒã‚¸ãƒˆãƒªã® config/ ã¨ worlds/ ã‚’é…å‚™
          cp -rv ./config/* ./bds/ 2>/dev/null || true
          cp -rv ./worlds ./bds/ 2>/dev/null || true
          
          echo "==== [STEP 2 COMPLETE] âœ… ===="

      # --- STEP 3: é€šä¿¡å…µ(playit.gg)ã®é…å‚™ ---
      - name: "Step 3: ğŸŒ playit.ggãƒˆãƒ³ãƒãƒ«å…µã®é…å‚™"
        run: |
          echo "==== [STEP 3 START] ===="
          curl -SsL -o playit https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
          chmod +x playit
          echo "Status: playit-agent ready âœ…"
          echo "==== [STEP 3 COMPLETE] âœ… ===="

      # --- STEP 4: ãƒˆãƒ³ãƒãƒ«é–‹é€š ---
      - name: "Step 4: âš¡ ãƒˆãƒ³ãƒãƒ«é–‹é€šãƒ—ãƒ­ã‚»ã‚¹"
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          echo "==== [STEP 4 START] ===="
          if [ -z "$PLAYIT_SECRET" ]; then
            ./playit > playit_log.txt 2>&1 &
          else
            ./playit --secret "$PLAYIT_SECRET" > playit_log.txt 2>&1 &
          fi
          sleep 12
          cat playit_log.txt | grep -E "https://playit.gg/claim/|connected" || echo "Status: Waiting for playit connection..."
          echo "==== [STEP 4 COMPLETE] âœ… ===="

      # --- STEP 5: ã‚µãƒ¼ãƒãƒ¼æœ€çµ‚èµ·å‹• ---
      - name: "Step 5: ğŸ® Minecraft Bedrock Server èµ·å‹•ï¼"
        working-directory: ./bds
        run: |
          echo "==== [STEP 5 START] ===="
          # èµ·å‹•å‰ã«ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
          ls -F
          
          echo "Executing: LD_LIBRARY_PATH=. ./bedrock_server"
          LD_LIBRARY_PATH=. ./bedrock_server
          echo "==== [STEP 5 FINISHED] ğŸ ===="
