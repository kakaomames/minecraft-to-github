name: Minecraft Server Engine

on:
  repository_dispatch:
    types: [start_beminecraft]

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      # --- STEP 1: ç’°å¢ƒæ•´å‚™ ---
      - name: "Step 1: ğŸ—ï¸ åŸºç¤ã‚¤ãƒ³ãƒ•ãƒ©ã®æ•´å‚™"
        run: |
          echo "==== [STEP 1 START] ===="
          echo "Action: Installing OS dependencies..."
          sudo apt-get update && sudo apt-get install -y libcurl4 curl unzip
          
          working_dir=$(pwd)
          echo "working_dir: ${working_dir}"
          echo "==== [STEP 1 COMPLETE] âœ… ===="

      # --- STEP 2: ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ¼ãƒãƒ¼æº–å‚™ ---
      - name: "Step 2: ğŸ“¦ ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ¼ãƒãƒ¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»è§£å‡"
        run: |
          echo "==== [STEP 2 START] ===="
          # éšŠå“¡æä¾›ã®IDã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šå®‰å®šã—ãŸURLã‚’æ§‹ç¯‰
          FILE_ID="16OlbXH73OzxJvUd80k0ARC0wAzgNm5_-"
          DOWNLOAD_URL="https://drive.google.com/uc?export=download&id=${FILE_ID}"
          echo "DOWNLOAD_URL: ${DOWNLOAD_URL}"
          
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
          curl -L -o bds_custom.zip "${DOWNLOAD_URL}"
          echo "Status: Download finished."
          
          # è§£å‡ãƒ•ã‚§ãƒ¼ã‚º
          mkdir -p bds
          unzip bds_custom.zip -d bds
          chmod +x ./bds/bedrock_server
          echo "Status: Server binary path is ./bds/bedrock_server"
          echo "==== [STEP 2 COMPLETE] âœ… ===="

      # --- STEP 3: é€šä¿¡å…µ(playit.gg)ã®é…å‚™ ---
      - name: "Step 3: ğŸŒ playit.ggãƒˆãƒ³ãƒãƒ«å…µã®é…å‚™"
        run: |
          echo "==== [STEP 3 START] ===="
          PLAYIT_DL_URL="https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64"
          echo "PLAYIT_DL_URL: ${PLAYIT_DL_URL}"
          
          curl -SsL -o playit ${PLAYIT_DL_URL}
          chmod +x playit
          
          playit_version=$(./playit --version)
          echo "playit_version: ${playit_version}"
          echo "==== [STEP 3 COMPLETE] âœ… ===="

      # --- STEP 4: ãƒˆãƒ³ãƒãƒ«é–‹é€š(ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰) ---
      - name: "Step 4: âš¡ ãƒˆãƒ³ãƒãƒ«é–‹é€šï¼†ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆèªè¨¼"
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          echo "==== [STEP 4 START] ===="
          if [ -z "$PLAYIT_SECRET" ]; then
            echo "Mode: [INITIAL SETUP] - No secret found in GitHub Secrets."
            ./playit > playit_log.txt 2>&1 &
          else
            echo "Mode: [AUTHENTICATED] - Using PLAYIT_SECRET."
            ./playit --secret "$PLAYIT_SECRET" > playit_log.txt 2>&1 &
          fi
          
          sleep 8 # æ¥ç¶šå¾…ã¡
          echo "--- Playit Connection Logs ---"
          cat playit_log.txt | grep -E "https://playit.gg/claim/|connected" || echo "Status: Processing..."
          echo "------------------------------"
          echo "==== [STEP 4 COMPLETE] âœ… ===="

      # --- STEP 5: ã‚µãƒ¼ãƒãƒ¼æœ€çµ‚èµ·å‹• ---
      - name: "Step 5: ğŸ® Minecraft Bedrock Server èµ·å‹•ï¼"
        run: |
          echo "==== [STEP 5 START] ===="
          echo "Command: LD_LIBRARY_PATH=. ./bedrock_server"
          
          cd bds
          # ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
          LD_LIBRARY_PATH=. ./bedrock_server
          
          echo "==== [STEP 5 FINISHED] ğŸ ===="
